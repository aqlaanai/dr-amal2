// Prisma Schema for Dr Amal Clinical OS v2.0
// Issue 2: Database Foundation - STRICT COMPLIANCE

generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

// Connection URL is configured via environment variable
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS (MANDATORY)
// ============================================================================
enum UserRole {
  provider
  admin
  parent
}

enum AccountStatus {
  active
  pending
  locked
}

enum ClinicalNoteStatus {
  draft
  finalized
  archived
}

enum PrescriptionStatus {
  draft
  issued
  completed
  cancelled
}

enum SessionStatus {
  scheduled
  waiting
  active
  completed
  archived
}

enum LabResultStatus {
  pending
  received
  reviewed
  archived
}

enum ImagingStatus {
  ordered
  scheduled
  completed
  cancelled
}

// ============================================================================
// USERS TABLE - Identity and authentication
// ============================================================================
model User {
  id            String        @id @default(uuid())
  tenantId      String
  email         String        @unique
  passwordHash  String
  firstName     String
  lastName      String
  phone         String?
  role          UserRole
  accountStatus AccountStatus @default(pending)

  // Session management (required for Issue 1 auth)
  refreshToken String?
  lastLoginAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  providedSessions LiveSession[]
  orderedLabs      LabResult[]      @relation("OrderedLabs")
  orderedImaging   ImagingOrder[]   @relation("OrderedImaging")
  clinicalNotes    ClinicalNote[]
  prescriptions    Prescription[]
  auditLogs        AuditLog[]

  @@index([email])
  @@index([accountStatus])
  @@index([tenantId])
}

// ============================================================================
// PATIENTS TABLE - Patient registry
// ============================================================================
model Patient {
  id                  String   @id @default(uuid())
  tenantId            String
  firstName           String
  lastName            String
  dateOfBirth         DateTime
  email               String?
  phone               String?
  address             String?
  emergencyContact    String?
  emergencyPhone      String?
  medicalRecordNumber String?  @unique
  guardianEmail       String?
  status              String   @default("active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  sessions      LiveSession[]
  clinicalNotes ClinicalNote[]
  prescriptions Prescription[]
  labResults    LabResult[]
  imagingOrders ImagingOrder[]

  @@index([firstName])
  @@index([lastName])
  @@index([dateOfBirth])
  @@index([status])
  @@index([tenantId])
}

// ============================================================================
// LIVE_SESSIONS TABLE - Patient encounters
// ============================================================================
model LiveSession {
  id          String        @id @default(uuid())
  tenantId    String
  patientId   String
  providerId  String
  status      SessionStatus
  scheduledAt DateTime
  startedAt   DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  patient       Patient        @relation(fields: [patientId], references: [id], onDelete: Restrict)
  provider      User           @relation(fields: [providerId], references: [id], onDelete: Restrict)
  clinicalNotes ClinicalNote[]

  @@index([patientId, status])
  @@index([providerId, scheduledAt])
  @@index([scheduledAt])
  @@index([tenantId])
}

// ============================================================================
// CLINICAL_NOTES TABLE - SOAP notes (immutable after finalization)
// ============================================================================
model ClinicalNote {
  id          String             @id @default(uuid())
  tenantId    String
  patientId   String
  providerId  String
  status      ClinicalNoteStatus
  subjective  String?
  objective   String?
  assessment  String?
  plan        String?
  finalizedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  patient  Patient      @relation(fields: [patientId], references: [id], onDelete: Restrict)
  session  LiveSession? @relation(fields: [sessionId], references: [id], onDelete: Restrict)
  provider User         @relation(fields: [providerId], references: [id], onDelete: Restrict)

  sessionId String?

  @@index([patientId, status])
  @@index([providerId, createdAt])
  @@index([sessionId])
  @@index([tenantId])
}

// ============================================================================
// PRESCRIPTIONS TABLE - Medication prescriptions (immutable after issuance)
// ============================================================================
model Prescription {
  id           String             @id @default(uuid())
  tenantId     String
  patientId    String
  providerId   String
  medication   String
  dosage       String
  duration     String
  instructions String?
  status       PrescriptionStatus
  issuedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  patient  Patient @relation(fields: [patientId], references: [id], onDelete: Restrict)
  provider User    @relation(fields: [providerId], references: [id], onDelete: Restrict)

  @@index([patientId, status])
  @@index([providerId, issuedAt])
  @@index([medication])
  @@index([tenantId])
}

// ============================================================================
// LAB_RESULTS TABLE - Laboratory tests (immutable after review)
// ============================================================================
model LabResult {
  id            String          @id @default(uuid())
  tenantId      String
  patientId     String
  orderedBy     String
  resultSummary String?
  abnormalFlag  Boolean         @default(false)
  status        LabResultStatus

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  patient          Patient @relation(fields: [patientId], references: [id], onDelete: Restrict)
  orderingProvider User    @relation("OrderedLabs", fields: [orderedBy], references: [id], onDelete: Restrict)

  @@index([patientId, status])
  @@index([orderedBy, createdAt])
  @@index([tenantId])
}

// ============================================================================
// IMAGING_ORDERS TABLE - Medical imaging orders and results
// ============================================================================
model ImagingOrder {
  id                 String        @id @default(uuid())
  tenantId           String
  patientId          String
  providerId         String
  studyType          String // e.g., "X-Ray", "CT Scan", "MRI", "Ultrasound"
  bodyPart           String // e.g., "Chest", "Head", "Abdomen"
  clinicalIndication String // Reason for study
  urgency            String        @default("routine") // "routine", "urgent", "stat"
  status             ImagingStatus @default(ordered)
  scheduledAt        DateTime?
  completedAt        DateTime?
  findings           String? // Radiologist findings (after completion)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  patient  Patient @relation(fields: [patientId], references: [id], onDelete: Restrict)
  provider User    @relation("OrderedImaging", fields: [providerId], references: [id], onDelete: Restrict)

  @@index([patientId, status])
  @@index([providerId, createdAt])
  @@index([status])
  @@index([tenantId])
}

// ============================================================================
// AUDIT_LOGS TABLE - Immutable append-only audit trail
// ============================================================================
model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String
  actorId    String
  action     String
  entityType String
  entityId   String
  timestamp  DateTime @default(now())
  metadata   String? // JSON string (SQLite doesn't have native JSON type)

  // Relationships
  actor User @relation(fields: [actorId], references: [id], onDelete: Restrict)

  @@index([actorId, timestamp])
  @@index([entityType, entityId, timestamp])
  @@index([action, timestamp])
  @@index([tenantId])
}
